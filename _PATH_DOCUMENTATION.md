# Tiki file and directory organisation

## History and nature of this document

This exercise started in 2013 on [this thread](https://sourceforge.net/p/tikiwiki/mailman/tikiwiki-devel/thread/19C606DC-E4D5-4319-85D2-5DFE41F65363%40tiki.org/#msg31218770).  It was dDocumented, then continued on the wiki around 2017 [File and directory structure revamp](https://dev.tiki.org/File-and-directory-structure-revamp), but then stalled.  A [Path Structure](https://doc.tiki.org/Path%20Structure) wiki page exists, but io too far from the code to be kept up to date.

Today (2023) this document aims allow finishing the path reorganisation effort by being exhaustive enough to allow for a realistic progressive migration over time with no ambiguity.

## Goals to achieve

* Developper onboarding and clarity
  * Allow developers to know what the content of a directory is about without having to review the whole code.
  * Keep reasonable directory depth, but mostly minimize scrolling.
* Ease of sysadmin:
  * Minimise complexity of webserver configuration
  * Clarify and separate as much as possible what needs to be backed-up.
* Modernization
  * Permit for not versioning (committing to Git) generated files, and compatibility with modern build approaches like vite.js
  * Facilitate to eventually move code out of the server root (for increased security, etc.)

### Files at the root of tiki

Many need to stay there, either because:

* developpers expect them there
* tooling expect them there and will pick them up by default (ex:  .gitignore, phpunit.xml.dist, .gitlab-ci.xml, etc.)
* They can really use the visibility even if they technically belong somewhere else (ex:  setup.sh, console.php)

Most of the tiki-*.php will progressively move to either src/php/routes or public/


## The directories

### KEEP paths (Currently implemented, should be hyperlinked to the adequate directory README.md)

This is the documentation, will hyperlink to the readme in each directory once moved.  If there is text here, it to clarify why it's NOT moving

* **[bin/](bin/README.md)**  
  * This is already generated by php console.php dev:configure, but there is no placeholder or README in git.
* **[vendor/](vendor/README.md)**
* **[vendor_bundled/](vendor_bundled/README.md)**
* **[vendor_custom/](vendor_custom/README.md)**

### MOVE paths

#### legend

* **newpath/**
  * ^= oldpath (means content of oldpath is moved to newpath)
  * <= oldpath (means oldpath becomes a subdirectory of newpath: newpath/oldpath)

#### TODO

* **private/**
  * All files that should NOT be served over HTTP directly by the webserver
  * Not versionned in Git (with some exceptions)
  * The whole tree needs to be backed up
  * **config/**
    * ^= db/
    * ^= db/config
  * **customisations/**
    * The structure would follow whatever mecanism multi-tiki and multi-domain require
    * ^= [_custom/](_custom/README.md)
  * **storage/**
    * Private storage.  Storage in the sense "Nonvolatile files manipulated by server code".  All files that need to be
      1. rw from PHP code
      2. do NOT need to be served over HTTP directly by the webserver
      3. Need to be backed-up
    * <= storage/fgal  According to the doc it should NOT be readable by webserver

* **public/**
  * All files that need to be served over HTTP directly by the webserver
  * ONLY storage/ should be writable by the web server user
  * Should be the (future) webserver root
    * This is still some way off, as for now:
      * vendor and vendor_bundled need to be accessible
  * **static/**
    * Images, fonts, etc. Sometimes called assets in other projects.  Versionned in Git.
    * <= img/
  * **generated/**
    * Any compiled or downloaded files to be served directly by the webserver.  Similar to the dist folder in pure JavaScript projects.  Empty in Git but filled in the tarballs.  Should not be backed up
  * **temp/**  
    * ^= temp/public
  * **themes/**
    * Themes have conflicting requirements
      1. They need some protection, as themes contain code (in the form of tpl files)
      2. They need to be self-contained to be useful.  As they contain assets, it implied they (or at least part of them) need to be http readable by every user.
      3. The theme installer needs to be able to write them to maintain functionnality.
      4. Installed themes (or user custom ones) need to survive upgrades.
      5. They need to be distributed with their bundled files (specifically scss => css), or php needs to be able to dynamically generated them when they are installed.
    * This requires some compromise, php needs to be able to write them, the web server needs to be able to serve parts of them.
    * Longer term, spliting the themes directory in 4 will at least make versionning easier, and things clearer:
      * public/static/base_themes for themes distributed in tiki
      * public/storage/themes for themes installed from the theme installer or user custom themes
      * public/customisations for behaviours currently in themes/css/Â and themes/js/
      * private/customisations for behaviours currently in themes/templates/

  * **storage/**
    * Public storage.  Storage in the sense "Nonvolatile files manipulated by server code". All files that need to be
      1. rw from PHP code
      2. Need to be served over HTTP directly by the webserver
      3. Need to be backed-up (are not volatile)
    * ^= storage/*  but only files that need to be served by the web server directly. So NOT fgal, prefsdoc and tiki-manager.
    * <= img/trackers/ as tracker_field_image (As of 2023-04-13, this is still used by lib/core/Tracker/Field/Image.php) 
    * <= img/wiki_up/ as plugin_img (As of 2023-04-13, this is still used by lib/wikiplugin/wikiplugin_img.php)
    * =< whelp/ as structure_webhelp (As of 2023-04-13, this is still used by lib/structures/structlib.php)

* **temp/**
  * Already exists, but progressively organise it and move more files to it.
  * **dev/** For development/compile/CI tools (vitejs, SCSS, GitLab-ci etc.). Need to be rw for the developper/sysadmin. Does not preclude having invisible files/folders, but encourages putting devtool caches here for easy inspection/clearing/exclusion from backups
  * **prod/** //For production, needs to be rw for PHP, and possibly other tools.
    * ^= storage/prefsdoc/

* **tests/** (both Vue and phpunit use testS, plural, so we do to)
  * **js/**
    * Only if we have js without the tests alongside, which will likely not be the case
  * **php/**
    * Alternative would be phpunit/, if we are not going to have the tests beside the code, may as well split them by tooling.
    * <= [lib/test/](lib/test/README.md)* split out, mostly in unit/ Naming moslty from <https://docs.phpunit.de/en/10.0/>
    * **unit/** Most current tests

* **tools/**
  * Developper tools and scripts. The difference with bin is that these cannot be called directly
    * ^= [doc/devtools](README.md)
    * <= [permissioncheck/](permissioncheck/README.md)

* **src/**
  * <= [installer/](installer/README.md)
  * **js/**
    * Should be organised according to framework and build systems.
    * Formerly static js should only move as they are processed by the build system, ideally we should avoid moving them to public/static/js
    * <= lib/vue-mf/
    * <= lib/jquery_tiki/ (lib/jquery_tiki/elfinder can move to to lib/elfinder, it has php files)
    * <= lib/tiki-js.js
    * <= lib/ckeditor_tiki
  * **lang/**
    * ^= [lang/](lang/README.md)
  * **lib/**
    * This needs to happen progressively, as this directory needs to be ASSUMED not part of the document root (although that is not yet the case). So the js files need to move first.
    * Internal reoganisations is out of scope until the sub-directories all have a README.md
    * ^= Most of current [lib/](lib/README.md)
    * <= [admin/](admin/README.md), renamed as adminpages/
    * **routes/**
      * <= Most of the current tiki-*.php if/when we move to a php routing solution
      * <= lists
  * **templates/**
    * ^= [templates/](templates/README.md)
    * They mirror the structure of the php sources, but are technically smarty, and are overridable in themes, and other mechanisms, and thus don't go into php/
  * **modules/**
    * ^= [modules/](modules/README.md)
  * **wikiplugins**
    * ^= [lib/wikiplugins/](lib/wikiplugins/README.md)

### DEPRECATED paths

Keep for a time, but don't add anything there.

### UNKNOWN paths (need to document)

* **doc/reports/**
  * What does that do, what uses it?
* **files/**
  * I think this is a remnant of Image Gallery (File gallery stores in storage/fgal by default).  benoitg 2023-04-04
* **profiles/**
  * Written to by console.php profile:export:init, and profile exports, which creates profiles/info.ini and profiles/name_of_exported_profile/
  * I cannot find anywhere this is actually read from except during the export process, but I'm having trouble believing that is true - benoitg 2023-04-12

### DELETE paths (including content)

Some of these may be created by scripts, and not currently versionned in git.

* **tests/**
  * Was that commited in error?

## Discussion

### 2 aspects that were not considered in previous discussions

1. The rise of JavaScript, which makes not requiring npm impossible for develompent environments.
2. The local/ and system/ is not realistic at top level, because it would preclude us from ever moving anything out of the document root, which makes security and ease of sysadmin harder, and is the way PHP is going.

### Moving the document root in the future

Most files can be moved to public as shown above.  But there are remaining problems:

Currently the webserver serves files directly from themes, and from vendor_bundled.  Unfortunately:

* themes/
  * must be readable by webserver, or proxyed because they contain assets.  Moving them to public is probably acceptable (but not ideal), as the only code they contain is .tpl.
* vendor_bundled/
  1. Some composer modules we use may not work outside the document root.  But that must be few of them these days
  2. A lot of what's there are javascript modules from <https://asset-packagist.org/>.  
  * I really don't think asset-packagist is a realistic (or even useful) long term solution.  We can't tree-shake packages, and they don't fit well in a modern javascript development flow, which is enough of a moving target as it is.
  * Most of them will naturally move to a npm/vite build process as time goes on.
* vendor_custom/ and vendor/
  1. These can contain Tiki packages <https://doc.tiki.org/Packages>, which include themes, profiles, css, etc.
  1. The good news is that they already copy themes to themes/ in pure php, we'd have to do the same for custom js and css (that's js and css to support the php code, so it can't simply be sent to themes).  

Drupal has the same requirement as we currently do of being installed in the document root <https://www.drupal.org/project/drupal/issues/1672986>.  This is what the Symfony Asset component is designed to manage, but it would be a lot of refactoring for tiki.

While we will now require npm for git installs, we can't rely on that for ftp installs.

### The problem with shared hosting without shell access

My proposal is the following:

1. Stop supporting "real" tiki at the document root
2. Most users should be able to set the DocumentRoot somewhere on the web hosting.
3. For those that can't (ex: cPanel primary domains), provide a .htaccess at the tiki root that will rewrite requests transparently for Apache.
4. Is there really anybody not covered by the above?

.htaccess at root would be something like

    RewriteEngine on
    RewriteCond %{REQUEST_URI} !^/public
    RewriteRule ^(.*)$ /public/$1 [NC,L]`
